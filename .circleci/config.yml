version: 2.1

jobs:
  build-android:
    docker:
      # Use a *real* cimg/android tag (no “manifest unknown”)
      # If you used 2024.06 before, add the patch version.
      - image: cimg/android:2024.06.1
    environment:
      ANDROID_SDK_ROOT: /opt/android/sdk
      ANDROID_HOME: /opt/android/sdk
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx2g -Dfile.encoding=UTF-8'"
      TERM: dumb

    steps:
      - checkout

      # -------- Gradle cache (robust even if some files don’t exist) --------
      - restore_cache:
          keys:
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ arch }}
            - v1-gradle-{{ arch }}
      - run:
          name: Print tree (helps if paths are off)
          command: |
            pwd
            ls -la
            echo "Using JDK:"
            java -version

      # -------- Make sure SDK is usable & licenses are accepted -------------
      - run:
          name: Prepare Android SDK & accept licenses
          command: |
            # Ensure the SDK dir exists and is writable (fixes “Failed to create SDK root dir”)
            sudo mkdir -p "$ANDROID_SDK_ROOT" || true
            sudo chown -R circleci:circleci "$ANDROID_SDK_ROOT"

            # Make local.properties so Gradle stops complaining about SDK location
            echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
            cat local.properties

            # Accept all licenses non-interactively
            yes | sdkmanager --licenses

            # Install the platform & tools your project needs (compiled against 35 per your logs)
            sdkmanager --install \
              "platforms;android-35" \
              "build-tools;35.0.0" \
              "platform-tools" \
              "cmdline-tools;latest"

      # -------------------------- Build -------------------------------------
      - run:
          name: Assemble Debug
          command: ./gradlew --no-daemon assembleDebug

      # ------------------------- Artifacts -----------------------------------
      - store_artifacts:
          path: app/build/outputs/apk/debug
          destination: apk

      - save_cache:
          key: v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ arch }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - ~/.android
            - ~/.cache

workflows:
  build:
    jobs:
      - build-android
