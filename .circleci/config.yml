version: 2.1

jobs:
  build:
    docker:
      # Use a real Android image so the SDK is preinstalled & writable
      - image: cimg/android:2024.01
    working_directory: ~/project

    environment:
      # Gradle behaves better in CI with these
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx2g -Dfile.encoding=UTF-8'"
      # The Android images already set this, but we export to be explicit
      ANDROID_SDK_ROOT: /opt/android/sdk
      ANDROID_HOME: /opt/android/sdk

    steps:
      - checkout

      # ---- Cache restore (handles both Groovy *.gradle and Kotlin *.gradle.kts) ----
      - restore_cache:
          keys:
            # include the wrapper and any gradle[.kts] files anywhere in the repo
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "settings.gradle" }}-{{ checksum "settings.gradle.kts" }}-{{ checksum "build.gradle" }}-{{ checksum "build.gradle.kts" }}
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - v1-gradle-

      # ---- Ensure SDK path is writable & create local.properties for AGP ----
      - run:
          name: Ensure Android SDK is available and writable
          command: |
            mkdir -p "$ANDROID_SDK_ROOT" || true
            sudo chown -R circleci:circleci "$ANDROID_SDK_ROOT" || true
            echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      # ---- Accept SDK licenses non-interactively ----
      - run:
          name: Accept Android SDK licenses
          command: |
            yes | sdkmanager --licenses || true

      # ---- (Optional) install the exact APIs your project uses ----
      # If your compileSdk is 35 (from your log), this guarantees tools are present.
      - run:
          name: Install Platform & Build-Tools matching compileSdk
          command: |
            sdkmanager --install \
              "platform-tools" \
              "platforms;android-35" \
              "build-tools;35.0.0" || true

      # ---- Build ----
      - run:
          name: Assemble Debug
          command: ./gradlew --no-daemon assembleDebug

      # ---- Cache save ----
      - save_cache:
          key: v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "settings.gradle" }}-{{ checksum "settings.gradle.kts" }}-{{ checksum "build.gradle" }}-{{ checksum "build.gradle.kts" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

      # ---- Artifacts (APK) ----
      - store_artifacts:
          path: app/build/outputs/apk/debug
          destination: apk-debug

workflows:
  build_and_test:
    jobs:
      - build
