version: 2.1

jobs:
  build:
    docker:
      # Pick a recent image with Java 17+ and the Android SDK
      - image: cimg/android:2024.01
    environment:
      # Keep these in sync with your Gradle config
      COMPILE_SDK: "36"
      BUILD_TOOLS: "36.0.0"
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx2g -Dfile.encoding=UTF-8'"
    steps:
      - checkout

      # Cache Gradle deps/wrapper (paths that really exist on a fresh checkout)
      - restore_cache:
          keys:
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "build.gradle.kts" }}-{{ checksum "settings.gradle.kts" }}
            - v1-gradle-

      # Make sure SDK location is known to Gradle
      - run:
          name: Point Gradle at the SDK
          command: |
            echo "sdk.dir=${ANDROID_SDK_ROOT:-/opt/android/sdk}" > local.properties
            cat local.properties

      # Accept all Android SDK licenses (non-interactive)
      - run:
          name: Accept Android SDK licenses
          command: yes | sdkmanager --licenses

      # Install the minimal packages needed to build (avoid emulator/system-images)
      - run:
          name: Install platform + build tools
          command: |
            sdkmanager --update
            sdkmanager "platform-tools" "platforms;android-${COMPILE_SDK}" "build-tools;${BUILD_TOOLS}" "cmdline-tools;latest"

      # Build & test
      - run:
          name: Build debug APK and run unit tests
          command: ./gradlew clean test assembleDebug --stacktrace

      - save_cache:
          key: v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "build.gradle.kts" }}-{{ checksum "settings.gradle.kts" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - ~/.android/build-cache

workflows:
  build_and_test:
    jobs:
      - build
