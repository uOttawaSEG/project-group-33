version: 2.1

jobs:
  build-android:
    docker:
      - image: cimg/android:2024.06.1
    environment:
      ANDROID_SDK_ROOT: /opt/android/sdk

    steps:
      - checkout
      - run: chmod +x ./gradlew

      - restore_cache:
          keys:
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ arch }}
            - v1-gradle-{{ arch }}

      - run:
          name: Android SDK + Licenses
          command: |
            echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
            yes | sdkmanager --licenses
            sdkmanager --install \
              "platforms;android-35" \
              "build-tools;35.0.2" \
              "platform-tools"

      # Build APK
      - run:
          name: Build Debug APK
          command: ./gradlew --no-daemon assembleDebug

      # Run ONLY local unit tests (fast, no emulator)
      - run:
          name: Run Unit Tests
          command: ./gradlew --no-daemon testDebugUnitTest

      - store_artifacts:
          path: app/build/outputs/apk/debug
          destination: apk

      - save_cache:
          key: v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ arch }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

workflows:
  build:
    jobs:
      - build-android
