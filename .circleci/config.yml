version: 2.1

jobs:
  build-android:
    docker:
      # Pin a real image tag that exists
      - image: cimg/android:2024.06.1
    environment:
      ANDROID_SDK_ROOT: /opt/android/sdk
      ANDROID_HOME: /opt/android/sdk
      # Force Gradle to use JDK 17 (required by recent AGP)
      ORG_GRADLE_PROJECT_orgGradleJavaHome: /usr/lib/jvm/java-17-openjdk-amd64
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3g -Dfile.encoding=UTF-8'"
      TERM: dumb

    steps:
      - checkout

      # Make sure Gradle wrapper is executable (very common CI failure)
      - run:
          name: Ensure gradlew is executable
          command: chmod +x ./gradlew

      # Cache Gradle (robust keys)
      - restore_cache:
          keys:
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ arch }}
            - v1-gradle-{{ arch }}

      - run:
          name: Print env for debugging
          command: |
            pwd
            ls -la
            echo "Java:"
            java -version
            echo "Gradle wrapper:"
            ./gradlew -v

      # If you have google-services.json in a secret env var (BASE64_GOOG_SERVICES_JSON),
      # write it here. If you already commit the file, delete this block.
      - run:
          name: (Optional) Restore google-services.json from env
          command: |
            if [ -n "$BASE64_GOOG_SERVICES_JSON" ]; then
              echo "$BASE64_GOOG_SERVICES_JSON" | base64 -d > app/google-services.json
              echo "Restored app/google-services.json"
            fi

      # Make sure SDK is writable, licenses accepted, and right tools installed
      - run:
          name: Prepare Android SDK & accept licenses
          command: |
            sudo mkdir -p "$ANDROID_SDK_ROOT" || true
            sudo chown -R circleci:circleci "$ANDROID_SDK_ROOT"
            echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
            yes | sdkmanager --licenses
            # Install platform/tools you compile against
            sdkmanager --install \
              "platforms;android-35" \
              "build-tools;35.0.2" \
              "platform-tools" \
              "cmdline-tools;latest"

      # Build
      - run:
          name: Assemble Debug
          command: ./gradlew --no-daemon assembleDebug

      # Test (optional but recommended)
      - run:
          name: Unit tests
          command: ./gradlew --no-daemon testDebugUnitTest

      # Artifacts
      - store_artifacts:
          path: app/build/outputs/apk/debug
          destination: apk

      - save_cache:
          key: v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ arch }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - ~/.android
            - ~/.cache

workflows:
  build:
    jobs:
      - build-android
