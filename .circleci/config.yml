version: 2.1

jobs:
  build:
    docker:
      # Pick a recent Android convenience image with JDK preinstalled
      - image: cimg/android:2024.09
    environment:
      ANDROID_HOME: /opt/android/sdk
      ANDROID_SDK_ROOT: /opt/android/sdk
      GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=1024m"
      TERM: dumb
    steps:
      - checkout

      # Cache Gradle & Android deps
      - restore_cache:
          keys:
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "**/*.gradle*" }}
            - v1-gradle-

      # Ensure required SDK components exist (adjust build-tools if needed)
      - run:
          name: Install Android SDK packages
          command: |
            sdkmanager --version
            yes | sdkmanager --licenses || true
            sdkmanager --install \
              "platform-tools" \
              "build-tools;36.0.0" \
              "platforms;android-36"

      # (Optional) update tools metadata
      - run:
          name: Update SDK package metadata
          command: sdkmanager --update || true

      # Build & unit tests (no emulator needed)
      - run:
          name: Assemble Debug
          command: ./gradlew assembleDebug --stacktrace
      - run:
          name: Unit tests
          command: ./gradlew testDebugUnitTest --stacktrace

      - save_cache:
          key: v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "**/*.gradle*" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

workflows:
  build_and_test:
    jobs:
      - build
