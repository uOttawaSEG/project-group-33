version: 2.1

jobs:
  android-build:
    docker:
      # pick a real, existing tag; examples: 2024.06.1, 2024.07.1, 2024.09
      - image: cimg/android:2024.07.1
    working_directory: ~/project
    environment:
      ANDROID_SDK_ROOT: /home/circleci/android-sdk
      ANDROID_HOME: /home/circleci/android-sdk
      GRADLE_USER_HOME: /home/circleci/.gradle
      # keep Gradle non-daemon in CI to avoid stray processes
      GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx2g"

    steps:
      - checkout

      # Ensure SDK root is writable and referenced by Gradle
      - run:
          name: Prepare SDK directory and local.properties
          command: |
            mkdir -p "$ANDROID_SDK_ROOT"
            echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties

      # Accept all SDK licenses without interactivity (avoid exit 141)
      - run:
          name: Accept Android SDK licenses
          command: |
            set +o pipefail
            yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses >/dev/null 2>&1 || true
            set -o pipefail

      # (Optional) Pre-install the platform/build-tools you target to avoid Gradle doing it
      - run:
          name: Install required SDK packages
          command: |
            sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
              "platform-tools" \
              "platforms;android-34" \
              "build-tools;34.0.0" || true

      # Cache Gradle wrapper + caches (use safe keysâ€”no ** globs that may not match)
      - restore_cache:
          keys:
            - gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "build.gradle" }}
            - gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - gradle-

      - run:
          name: Build Debug
          command: ./gradlew --no-daemon assembleDebug

      - save_cache:
          key: gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "build.gradle" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

      - store_artifacts:
          path: app/build/outputs
          destination: outputs

workflows:
  android:
    jobs:
      - android-build
