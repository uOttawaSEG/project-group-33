version: 2.1

jobs:
  android-build:
    docker:
      # Use a VALID Android image. 2024.06 doesn't exist.
      # 2024.01 is stable and includes the commandline tools + JDK.
      - image: cimg/android:2024.01
    environment:
      # The cimg/android image already sets these, but we set them explicitly
      ANDROID_SDK_ROOT: /opt/android/sdk
      ANDROID_HOME: /opt/android/sdk
      GRADLE_USER_HOME: ~/.gradle
    steps:
      - checkout

      # ---- Restore Gradle caches (no fragile checksums of build.gradle) ----
      - restore_cache:
          keys:
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ .Branch }}-{{ .Revision }}
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ .Branch }}
            - v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - v1-gradle-

      # ---- Make sure required SDK components are present & accept licenses ----
      - run:
          name: Install Android SDK components (non-interactive)
          command: |
            sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --update
            # Accept all licenses without prompting
            yes | sdkmanager --sdk_root="$ANDROID_SDK_ROOT" --licenses > /dev/null

            # Install exactly what the project needs. You said you compile with 35.
            sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
              "platform-tools" \
              "platforms;android-35" \
              "build-tools;35.0.0"

      # ---- Build ----
      - run:
          name: Assemble Debug
          command: |
            chmod +x ./gradlew
            ./gradlew --no-daemon assembleDebug

      # ---- Save caches ----
      - save_cache:
          key: v1-gradle-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ .Branch }}-{{ .Revision }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper
            - ~/.android/build-cache

workflows:
  build:
    jobs:
      - android-build
