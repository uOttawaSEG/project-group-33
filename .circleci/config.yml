version: 2.1

orbs:
  android: circleci/android@3.1.0   # gives sdkmanager helpers

jobs:
  build:
    docker:
      - image: cimg/android:2024.09    # JDK 17 + Android SDK preinstalled
    environment:
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx2048m'"
    steps:
      - checkout

      # ---- Gradle cache (include .gradle.kts!) ----
      - restore_cache:
          keys:
            - gradle-v1-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "build.gradle.kts" }}-{{ checksum "settings.gradle.kts" }}
            - gradle-v1-

      # ---- Make Android SDK visible to Gradle ----
      # cimg/android sets ANDROID_SDK_ROOT. Wire it into local.properties for Gradle.
      - run: echo "sdk.dir=${ANDROID_SDK_ROOT}" > local.properties

      # ---- Accept licenses non-interactively & install required packages ----
      - run: yes | sdkmanager --licenses
      # Adjust versions to match your project; for compileSdk=36 you need these:
      - run: sdkmanager "platform-tools" "platforms;android-36" "build-tools;36.0.0" || \
          (echo "Android 36 not found; installing 35 instead" && \
          sdkmanager "platforms;android-35" "build-tools;35.0.0")

      # ---- Build & test ----
      - run: ./gradlew clean test :app:assembleDebug --stacktrace

      - save_cache:
          key: gradle-v1-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}-{{ checksum "build.gradle.kts" }}-{{ checksum "settings.gradle.kts" }}
          paths:
            - ~/.gradle/caches
            - ~/.gradle/wrapper

      # Artifacts (optional)
      - store_artifacts:
          path: app/build/outputs/apk
          destination: apk

workflows:
  build_and_test:
    jobs:
      - build
